<!DOCTYPE html>
<!-- 
    播放MP4 DEMO
-->
<html>
<head>
    <link href="/favicon.ico" rel="icon" type="image/x-icon" />

    <meta charset="utf-8">

    <title>VideoMissilePlayer Hevc Demo</title>
    <!--
        0.引入JS
          记住 wasm 和 js统一目录
    -->
    <script src="dist/missile.js"></script>
    <style>
        #pts_label {
            float: right; 
            padding-right:10px;
            color: white;
        }
        .progress {
            width : 100%;
            /*height: 30px;
            border-radius: 1em;*/
            border: 1px solid black;  
            background-color: #e6e6e6;
            color: yellow; /*IE10*/
        }
        progress::-webkit-progress-bar {
            background: black;
            /*border-radius: 8px;*/
        }
        progress::-webkit-progress-value {
            background: yellow;
            /*border-radius: 8px;*/
        }
    </style>
</head>
<body style="background-color: #666666">


<center>
    <h3><font color="white"><i>Video Missile Hevc Player Demo Show</i></font></h3>

    <!--
        1.在这里初始化一个div的box
    -->
    <div id="glplayer">
    </div>
</center>

<div style="width:600px;margin:0 auto;">
    <div id="pts_label">
        00:00:00 / 00:00:00
    </div>
    <progress class="progress" id="play_progress" value="1" max="100"></progress>
</div>

<center>
    <div style="background-color: #aaaaaa;margin:10px;width:600px;height:200px;">
        <div id="statusDiv" style="color:gray"></div>

        Input Media Address
        <br><br>

        <input style="width:90%;height:30px;text-align: center;background-color: #e9e9e9" type="text" id="play_url" value="/Movies/video40_265_1.MP4"> <!-- disabled="disabled" -->
        <!-- <input style="width:90%;height:30px;text-align: center;background-color: #e9e9e9" type="text" id="play_url" value="/Movies/jitui_265.mp4" disabled="disabled"  > -->
        <br>
        <br>

        <button id="initMedia" onclick="initMedia()">解析媒资 [>] </button>
        <button id="startPlay" onclick="startPlay()" disabled="disabled">开始 [>] </button>
        <button id="stopPlay" onclick="stopPlay()" disabled="disabled">结束 [||] </button>
    </div>

</center>

<script>
    g_dur_txt = "00:00:00";

    function blobRead(url, callback) {
        console.log(url);
        var xhr = new XMLHttpRequest();

        xhr.open('GET', url, true);
        xhr.responseType = 'blob';

        xhr.onload = function(res) {
            // console.log(xhr);
            if (xhr.status === 200) {
                var type = xhr.getResponseHeader('Content-Type');
                var blob = new Blob([this.response], {type: type});
                if (typeof window.navigator.msSaveBlob !== 'undefined') {
                    /*
                     * For IE
                     * >=IE10 
                     */
                } else {
                    callback(blob);
                }
            }
        };
        xhr.send();
    }

    function loadMedia() {
        console.log("load media");

        var play_url = document.getElementById("play_url").value;
        blobRead(play_url, function(blob) {
            console.log(blob);
            fileReader.readAsArrayBuffer(blob);
        });
    }

    function startPlay() {
        player.play(function() {
            // play progress
            var tmp_video_pts_val = VIDEO_PTS_VAL < 0 ? 0 : VIDEO_PTS_VAL;
            console.log("tmp_video_pts_val: " + tmp_video_pts_val);

            document.getElementById("play_progress").value = tmp_video_pts_val;
            var pts_txt_hour = Math.floor(tmp_video_pts_val / 3600);
            var pts_txt_minu = Math.floor((tmp_video_pts_val % 3600) / 60);
            var pts_txt_seco = Math.floor((tmp_video_pts_val % 60));
            var pts_txt = pts_txt_hour + ":" + pts_txt_minu + ":" + pts_txt_seco;

            console.log("pts_txt:" + pts_txt);
            document.getElementById("pts_label").innerHTML = pts_txt + "/" + g_dur_txt;
        });
        // 这部分为了可读性 没必要2次封装
        document.getElementById("startPlay").disabled = true;
        document.getElementById("stopPlay").disabled  = false;
    }

    function stopPlay() {
        if (timeLoop) {
            window.clearInterval(timeLoop);
            player.stop();
        }
        // loadMedia();
        document.getElementById("startPlay").disabled = true;
        document.getElementById("stopPlay").disabled  = true;
    }

    /*
     * Execute
     */
    // const SLICE_TAG_AUDIO   = 0x08;
    // const SLICE_TAG_VIDEO   = 0x09;
    // const PLAY_CMD          = "1001";
    // const DISCONN_CMD       = "1002";

    var mp4Obj      = InitMp4Parser();
    var fileReader  = new FileReader();
    var player      = null;
    var playerStatus= false;
    var timeLoop    = null;


    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms))
    }

    function playerCreateCallback() {
        var durationMs = mp4Obj.getDurationMs();
        console.log("createPlayer Done!");
        player.setDurationMs(durationMs);

        // player load success
        timeLoop = window.setInterval(function(){
        // while (true) {
            // var popData     = mp4Obj.popBuffer(1)["data"];
            // var popDataAudio= mp4Obj.popBuffer(2)["data"];
            var popData     = mp4Obj.popBuffer(1)

            // if (popData != null && popData["pts"] > 100) {
                var popDataAudio= mp4Obj.popBuffer(2);
                // {pts: 95.29469387755103, data: Uint8Array(1117)}
                // console.log("after popBuffer:");
                // console.log(popDataAudio)
                
                if (popData != null) {
                    player.appendHevcFrame(popData);
                    // console.log("to append video");
                    // console.log(popData);

                } else {
                    // break;
                }

                if (popDataAudio && popDataAudio != null) { //  && popDataAudio.length > 4
                    // console.log("to append audio");
                    // console.log(popDataAudio);
                    player.appendAACFrame(popDataAudio);
                    
                }

                // console.log("=================================");
                if (popDataAudio == null && popData == null) {
                    // break;
                    console.log("to break loop");
                    window.clearInterval(timeLoop);
                }
            // } // end seek 100

        // }
        }, 1);

        setTimeout(function() {
            document.getElementById("startPlay").disabled = false;
        }, 3000);
    }


    function fileReaderOnLoad() {
        // demux mp4
        var streamBuf = new Uint8Array(fileReader.result).buffer;
        console.log(streamBuf);
        mp4Obj.demux(streamBuf);
        var durationMs  = mp4Obj.getDurationMs();
        var fps         = mp4Obj.getFPS();
        var sampleRate  = mp4Obj.getSampleRate();
        var size        = mp4Obj.getSize();

        // player progress max
        document.getElementById("play_progress").value = 0;
        var durationSec = durationMs / 1000;
        document.getElementById("play_progress").max = durationSec;

        var dur_txt_hour = Math.floor(durationSec / 3600);
        var dur_txt_minu = Math.floor((durationSec % 3600) / 60);
        var dur_txt_seco = Math.floor((durationSec % 60));
        g_dur_txt = dur_txt_hour + ":" + dur_txt_minu + ":" + dur_txt_seco;
        document.getElementById("pts_label").innerHTML = "0:0:0/" + g_dur_txt;


        console.log("get fps" + fps + ",sampleRate : " + sampleRate);
        console.log(size);

        // function playerCreateCallback() {
        //     console.log("createPlayer Done!");
        //     player.setDurationMs(durationMs);

        //     // player load success
        //     timeLoop = window.setInterval(function(){
        //     // while (true) {
        //         // var popData     = mp4Obj.popBuffer(1)["data"];
        //         // var popDataAudio= mp4Obj.popBuffer(2)["data"];
        //         var popData     = mp4Obj.popBuffer(1)

        //         // if (popData != null && popData["pts"] > 100) {
        //             var popDataAudio= mp4Obj.popBuffer(2);
        //             // {pts: 95.29469387755103, data: Uint8Array(1117)}
        //             // console.log("after popBuffer:");
        //             // console.log(popDataAudio)
                    
        //             if (popData != null) {
        //                 player.appendHevcFrame(popData);
        //                 // console.log("to append video");
        //                 // console.log(popData);

        //             } else {
        //                 // break;
        //             }

        //             if (popDataAudio && popDataAudio != null) { //  && popDataAudio.length > 4
        //                 // console.log("to append audio");
        //                 // console.log(popDataAudio);
        //                 player.appendAACFrame(popDataAudio);
                        
        //             }

        //             // console.log("=================================");
        //             if (popDataAudio == null && popData == null) {
        //                 // break;
        //                 console.log("to break loop");
        //                 window.clearInterval(timeLoop);
        //             }
        //         // } // end seek 100

        //     // }
        //     }, 1);

        //     document.getElementById("startPlay").disabled = false;
        // }

        // width       : size["width"] + "px",
        // height      : size["height"] + "px",
        if (playerStatus) {
            player.settingPlayer({
                fps             : fps,
                sampleRate      : sampleRate
            });
            playerCreateCallback();
        } else {
            // playerStatus = player.createPlayer({
            //     width           : "600px",
            //     height          : "600px",
            //     fps             : fps,
            //     sampleRate      : sampleRate,
            //     fixed           : false,
            //     appendHevcType  : APPEND_TYPE_FRAME
            // }, playerCreateCallback);
        }
        document.getElementById("initMedia").disabled = false;
    }

    fileReader.onload = fileReaderOnLoad; // init player
        

// try {
// window.setInterval(function(){
//     var popData = mp4Obj.popBuffer(1);
//     if (popData != null) {
//         player.appendHevcFrame(streamBytes);
//     }
//     console.log(popData);
// }, 1000/25); // 1000/24 fps=24
// } catch (e) {
//     alert('Crash[brower]! Please refresh your page');
//     throw e;
// }

    function initMedia() {
        console.log("init media");
        document.getElementById("initMedia").disabled = true;
        stopPlay();
        loadMedia();
        // player = Init(loadMedia);
    }

    window.onload = function() {
        player = Init(function() {
            playerStatus = player.createPlayer({
                width           : "600px",
                height          : "600px",
                appendHevcType  : APPEND_TYPE_FRAME
            }, null);
        });
        
    };

</script>
</body>
</html>