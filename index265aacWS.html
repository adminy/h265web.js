<!DOCType html>
<html>
<!-- 
    播放 hevc直播流 DEMO
-->
<head>
    <meta charset="utf-8">
    <title>VideoMissileLive Demo</title>
    <script src="dist/missile.js"></script>
</head>
<body style="background-color: #666666">

    <center>
        <h3><font color="white"><i>Video Missile Hevc Player Demo Show</i></font></h3>

        <!--
            1.在这里初始化一个div的box
        -->
        <div id="glplayer">
        </div>
    </center>

    <center>
        <div style="background-color: #aaaaaa;margin:10px;width:600px;height:200px;">

            <div id="statusDiv" style="color:gray"></div>
            <br>
            <br>

            <button id="startPlay" onclick="startPlay()">Play</button>
            <button onclick="pause()">Pause</button>
            <button onclick="continues()">Continue</button>
            <button onclick="stopPlay()">Stop</button>
        </div>
    </center>

    <script>
        const SLICE_TAG_AUDIO   = 0x08;
        const SLICE_TAG_VIDEO   = 0x09;
        const PLAY_CMD          = "1001";
        const DISCONN_CMD       = "1002";

        // var ws      = null;
        var player  = null;

        window.onload = function() {

            document.getElementById("statusDiv").innerHTML      = "Loading...";
            document.getElementById("startPlay").disabled       = true;

            /**
                2.在这里初始化播放器对象
                @param width    播放器宽度
                @param height   播放器高度
                @param fps      帧率
                @param fixed    true: 严格按照长宽充满容器 
                                false:按照比例
             */
             
            player = Init(function() {
                player.createPlayer({
                    width   : "600px",
                    height  : "600px",
                    fps     : 25,
                    fixed   : false
                }, initSucPlay); // init player
            });
            
            
        };

        function formatProtocalData(message) {
            // 00 00 00 01 40 01 0c 01 ff ff 01 60 00 00 03 00 90 00 00 03 00 00 03 00 3f 95 98 09
            // console.log("message:");
            // console.log(message);
            // console.log(message.length);
            var aacHexTextDataLen   = message.length - 2; // decr the slice_tag(audio/video 08 09)

            var streamData          = new Uint8Array(aacHexTextDataLen / 2);
            var tag_type            = parseInt(message[0] + message[1], 16);

            for (var i = 2; i < message.length; i += 2) {
                var strByte     = message[i] + message[i+1];
                var streamByte  = parseInt(strByte, 16);
                streamData[(i-2)/2] = streamByte;
            }

            return {
                streamData  : streamData,
                tag_type    : tag_type
            };
        };

        // websocket
        var ws = null;

        function recvData() {
            ws.send(PLAY_CMD);
        };

        function getLiveWS (ip, port, callback) {
            // ws = new WebSocket("ws:127.0.0.1:10083");
            ws = new WebSocket("ws:"+ip+":"+port);

            ws.onopen = function(msg){
                console.log("websocket opened!");
                callback();
            }
            ws.onmessage = function(message){

                var streamStr   = message.data;
                var formatRet   = formatProtocalData(streamStr);

                var streamBytes = formatRet["streamData"];
                var tag_type    = formatRet["tag_type"];

                if (tag_type == SLICE_TAG_VIDEO) {
                    player.appendHevcFrame(streamBytes);
                } else if (tag_type == SLICE_TAG_AUDIO) {
                    player.appendAACFrame(streamBytes);
                }
                
            }
            ws.onerror = function(err){
                console.log("error:"+err.name+err.number);
            }
            ws.onclose = function(){
                console.log("websocket closed!")
            }
        };

        function endLive() {
            if (ws != null) {
                ws.send(DISCONN_CMD);

                console.log(ws.readyState);
                ws.close();
                console.log(ws.readyState);
                ws.onclose = function(){};
                ws.onmessage = function(){};
                ws.onerror = function(){};
                ws.onopen = function(){};

                ws = null;
                console.log(ws);
            }
        };

        // oper
        function startPlay() {
            getLiveWS("127.0.0.1", 10084, initSucWSPlay); // conn ws
            player.play();
        }

        function pause() {
            player.pause();
        }

        function continues() {
            player.continues();
        }

        function stopPlay() {
            endLive();
            player.stop();
        }

        function initSucPlay() {
            document.getElementById("statusDiv").innerHTML      = "";
            document.getElementById("startPlay").disabled       = false;

            // document.getElementById("startPlay").click();
        }

        function initSucWSPlay() {
            document.getElementById("statusDiv").innerHTML      = "";
            recvData(); // start get hevc stream play
        }



    </script>
</body>
</html>
